<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Jelly: Example1_BlobNode.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Jelly
   </div>
   <div id="projectbrief">C++ embeddable database system for online games.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="doc-content">
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">Example1_BlobNode.cpp</div></div>
</div><!--header-->
<div class="contents">
<p>Basic example of how to save and load blobs.</p>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;jelly/API.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span></div>
<div class="line">main(</div>
<div class="line">    <span class="keywordtype">int</span>     <span class="comment">/*aNumArgs*/</span>,</div>
<div class="line">    <span class="keywordtype">char</span>**  <span class="comment">/*aArgs*/</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// First we&#39;re going to need a host object. This provides our node an interface to talk to </span></div>
<div class="line">    <span class="comment">// the system.</span></div>
<div class="line">    <span class="comment">//</span></div>
<div class="line">    <span class="comment">// jelly::DefaultHost provides a default, one size (mostly) fits all, implementation of the </span></div>
<div class="line">    <span class="comment">// jelly::IHost interface, but you can implement your own if you&#39;re so inclined.</span></div>
<div class="line">    <a id="_a0" name="_a0"></a><a class="code hl_class" href="classjelly_1_1DefaultHost.html">jelly::DefaultHost</a> host(</div>
<div class="line">        <span class="stringliteral">&quot;.&quot;</span>,                                    <span class="comment">// Put database files here.</span></div>
<div class="line">        <span class="stringliteral">&quot;example1&quot;</span>,                             <span class="comment">// Database files will be prefixed with this.</span></div>
<div class="line">        NULL);                                  </div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Make sure the database is gone.</span></div>
<div class="line">    host.<a id="a1" name="a1"></a><a class="code hl_function" href="classjelly_1_1DefaultHost.html#ab1de3ff7219ffbd3c3b475028b874ff8">DeleteAllFiles</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Make a typedef for our BlobNode type because we&#39;re lazy and don&#39;t want </span></div>
<div class="line">    <span class="comment">// to type too much.</span></div>
<div class="line">    <span class="keyword">typedef</span> <a id="_a2" name="_a2"></a><a class="code hl_class" href="classjelly_1_1BlobNode.html">jelly::BlobNode</a></div>
<div class="line">    &lt;</div>
<div class="line">        <a id="_a3" name="_a3"></a><a class="code hl_struct" href="structjelly_1_1UIntKey.html">jelly::UIntKey&lt;uint32_t&gt;</a>                <span class="comment">// Our blob keys will be uint32_t.</span></div>
<div class="line">    &gt; BlobNodeType;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Create our blob node.</span></div>
<div class="line">    BlobNodeType blobNode(</div>
<div class="line">        &amp;host,                                  <span class="comment">// Associate the node with this host.</span></div>
<div class="line">        1);                                     <span class="comment">// Use globally unique node id 1.</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Do a save</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Define a blob with the string &quot;hello&quot; inside</span></div>
<div class="line">        <a id="_a4" name="_a4"></a><a class="code hl_class" href="classjelly_1_1Buffer.html">jelly::Blob</a> blob;</div>
<div class="line"> </div>
<div class="line">        {</div>
<div class="line">            blob.<a id="a5" name="a5"></a><a class="code hl_function" href="classjelly_1_1Buffer.html#a160505d05d5ed2e7c4821610a15cfb7d">SetSize</a>(5);</div>
<div class="line">            memcpy(blob.<a id="a6" name="a6"></a><a class="code hl_function" href="classjelly_1_1Buffer.html#ae3566191507bbb63b45cc764dba094b6">GetPointer</a>(), <span class="stringliteral">&quot;hello&quot;</span>, 5);</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Define a request to save it.</span></div>
<div class="line">        BlobNodeType::Request req;</div>
<div class="line"> </div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Set the blob key we want to save.</span></div>
<div class="line">            req.SetKey(12345);</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// Set the sequence number of the blob. When the database encounters multiple </span></div>
<div class="line">            <span class="comment">// instances of the same blob (identified by key), it will use the sequence number </span></div>
<div class="line">            <span class="comment">// to determine which one is latest.</span></div>
<div class="line">            <span class="comment">// Note that the application is fully responsible for updating the sequence number</span></div>
<div class="line">            <span class="comment">// whenever it makes any changes to the blob.</span></div>
<div class="line">            req.SetSeq(1);</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// Set the blob for the request. We need to copy the blob because ownership of the</span></div>
<div class="line">            <span class="comment">// object has to be transfered to the request.</span></div>
<div class="line">            req.SetBlob(blob.<a id="a7" name="a7"></a><a class="code hl_function" href="classjelly_1_1Buffer.html#a7f727fc78db1c4463ac8a40d6ce8102d">Copy</a>());</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Submit a &quot;set&quot; request to the blob node. The caller owns the request object and must</span></div>
<div class="line">        <span class="comment">// make sure it remains valid until the request has completed.</span></div>
<div class="line">        blobNode.Set(&amp;req);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// At this point the request is queued inside the blob node. Now we&#39;ll make the blob node </span></div>
<div class="line">        <span class="comment">// process all requests in the queue.</span></div>
<div class="line">        blobNode.ProcessRequests();</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Now the request has been written to the write-ahead-log (WAL), but it hasn&#39;t actually </span></div>
<div class="line">        <span class="comment">// been written to disk yet. Because we&#39;re not sure that it&#39;s on disk yet, the request</span></div>
<div class="line">        <span class="comment">// hasn&#39;t been flagged as completed yet. </span></div>
<div class="line">        JELLY_ASSERT(!req.IsCompleted());</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// In order for this to happen we&#39;ll need to flush the pending WAL.</span></div>
<div class="line">        blobNode.FlushPendingWAL();</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Now the request will be completed.</span></div>
<div class="line">        JELLY_ASSERT(req.IsCompleted());</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// REQUEST_RESULT_OK means everything went as expected.</span></div>
<div class="line">        JELLY_ASSERT(req.GetResult() == <a id="a8" name="a8"></a>jelly::REQUEST_RESULT_OK);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Now try to load it back</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Define a request to load it.</span></div>
<div class="line">        BlobNodeType::Request req;</div>
<div class="line"> </div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// Set the blob key we want to load</span></div>
<div class="line">            req.SetKey(12345);</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// Set the minimum blob sequence number we&#39;ll accept. We know we just saved with</span></div>
<div class="line">            <span class="comment">// sequence number 1, so let&#39;s demand it&#39;s at least that.</span></div>
<div class="line">            req.SetSeq(1);          </div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Submit a &quot;get&quot; request.</span></div>
<div class="line">        blobNode.Get(&amp;req);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Again we need to process requests before anything happens.</span></div>
<div class="line">        blobNode.ProcessRequests();</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Unlike set requests, get requests don&#39;t cause anything to be save to disk - so </span></div>
<div class="line">        <span class="comment">// they&#39;ll be flagged as completed immediately after being processed.</span></div>
<div class="line">        JELLY_ASSERT(req.IsCompleted());</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Again REQUEST_RESULT_OK means everything is great.</span></div>
<div class="line">        JELLY_ASSERT(req.GetResult() == jelly::REQUEST_RESULT_OK);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">// Read the blob and make sure we got the right data back.</span></div>
<div class="line">        <span class="keyword">const</span> <a id="_a9" name="_a9"></a><a class="code hl_class" href="classjelly_1_1IBuffer.html">jelly::IBuffer</a>* blob = req.GetBlob();</div>
<div class="line">        JELLY_ASSERT(blob-&gt;<a id="a10" name="a10"></a><a class="code hl_function" href="classjelly_1_1IBuffer.html#a7fbbb6bbe927e08dcce70dbb0cfda747">GetSize</a>() == 5);</div>
<div class="line">        JELLY_ASSERT(memcmp(blob-&gt;<a id="a11" name="a11"></a><a class="code hl_function" href="classjelly_1_1IBuffer.html#a064df8f1978207146ec2eebfc18f7580">GetPointer</a>(), <span class="stringliteral">&quot;hello&quot;</span>, 5) == 0);</div>
<div class="line">        JELLY_UNUSED(blob);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> EXIT_SUCCESS;</div>
<div class="line">}</div>
<div class="ttc" id="aclassjelly_1_1BlobNode_html"><div class="ttname"><a href="classjelly_1_1BlobNode.html">jelly::BlobNode</a></div><div class="ttdoc">A node for storing blobs.</div><div class="ttdef"><b>Definition</b> BlobNode.h:34</div></div>
<div class="ttc" id="aclassjelly_1_1Buffer_html"><div class="ttname"><a href="classjelly_1_1Buffer.html">jelly::Buffer</a></div><div class="ttdoc">Binary buffer object implementing the IBuffer interface.</div><div class="ttdef"><b>Definition</b> Buffer.h:21</div></div>
<div class="ttc" id="aclassjelly_1_1Buffer_html_a160505d05d5ed2e7c4821610a15cfb7d"><div class="ttname"><a href="classjelly_1_1Buffer.html#a160505d05d5ed2e7c4821610a15cfb7d">jelly::Buffer::SetSize</a></div><div class="ttdeci">void SetSize(size_t aSize) noexcept override</div><div class="ttdoc">Set size of buffer. Existing data is retained, but if new size is smaller than the previous one,...</div><div class="ttdef"><b>Definition</b> Buffer.h:111</div></div>
<div class="ttc" id="aclassjelly_1_1Buffer_html_a7f727fc78db1c4463ac8a40d6ce8102d"><div class="ttname"><a href="classjelly_1_1Buffer.html#a7f727fc78db1c4463ac8a40d6ce8102d">jelly::Buffer::Copy</a></div><div class="ttdeci">IBuffer * Copy() const noexcept override</div><div class="ttdoc">Make copy of buffer.</div><div class="ttdef"><b>Definition</b> Buffer.h:136</div></div>
<div class="ttc" id="aclassjelly_1_1Buffer_html_ae3566191507bbb63b45cc764dba094b6"><div class="ttname"><a href="classjelly_1_1Buffer.html#ae3566191507bbb63b45cc764dba094b6">jelly::Buffer::GetPointer</a></div><div class="ttdeci">const void * GetPointer() const noexcept override</div><div class="ttdoc">Get const pointer to data contained in buffer.</div><div class="ttdef"><b>Definition</b> Buffer.h:124</div></div>
<div class="ttc" id="aclassjelly_1_1DefaultHost_html"><div class="ttname"><a href="classjelly_1_1DefaultHost.html">jelly::DefaultHost</a></div><div class="ttdoc">Default implementation of the IHost interface, which nodes use to interact with the system.</div><div class="ttdef"><b>Definition</b> DefaultHost.h:20</div></div>
<div class="ttc" id="aclassjelly_1_1DefaultHost_html_ab1de3ff7219ffbd3c3b475028b874ff8"><div class="ttname"><a href="classjelly_1_1DefaultHost.html#ab1de3ff7219ffbd3c3b475028b874ff8">jelly::DefaultHost::DeleteAllFiles</a></div><div class="ttdeci">void DeleteAllFiles(uint32_t aNodeId=UINT32_MAX)</div><div class="ttdoc">Deletes all database files associated with specified node id.</div></div>
<div class="ttc" id="aclassjelly_1_1IBuffer_html"><div class="ttname"><a href="classjelly_1_1IBuffer.html">jelly::IBuffer</a></div><div class="ttdoc">Abstract interface for a binary buffer.</div><div class="ttdef"><b>Definition</b> IBuffer.h:12</div></div>
<div class="ttc" id="aclassjelly_1_1IBuffer_html_a064df8f1978207146ec2eebfc18f7580"><div class="ttname"><a href="classjelly_1_1IBuffer.html#a064df8f1978207146ec2eebfc18f7580">jelly::IBuffer::GetPointer</a></div><div class="ttdeci">virtual const void * GetPointer() const =0</div><div class="ttdoc">Get const pointer to data contained in buffer.</div></div>
<div class="ttc" id="aclassjelly_1_1IBuffer_html_a7fbbb6bbe927e08dcce70dbb0cfda747"><div class="ttname"><a href="classjelly_1_1IBuffer.html#a7fbbb6bbe927e08dcce70dbb0cfda747">jelly::IBuffer::GetSize</a></div><div class="ttdeci">virtual size_t GetSize() const =0</div><div class="ttdoc">Returns the size of the buffer.</div></div>
<div class="ttc" id="astructjelly_1_1UIntKey_html"><div class="ttname"><a href="structjelly_1_1UIntKey.html">jelly::UIntKey</a></div><div class="ttdoc">Template for unsigned integer keys.</div><div class="ttdef"><b>Definition</b> UIntKey.h:13</div></div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
